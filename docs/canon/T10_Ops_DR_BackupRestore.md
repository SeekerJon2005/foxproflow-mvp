\# FoxProFlow CANON — T10 • Ops: DR / Backup / Restore



\## T10 (Draft→Canon) • Версия v0.1 • Дата: 2025-12-27



\*\*Создал:\*\* Архитектор Яцков Евгений Анатольевич  

\*\*Доступ:\*\* Архитектор Яцков Евгений Анатольевич  

\*\*Статус:\*\* Draft / Active



---



\## 0) Цель и смысл



Этот документ делает восстановление FoxProFlow \*\*воспроизводимым\*\*:

\- мы заранее знаем \*\*что бэкапим\*\*, \*\*как бэкапим\*\*, \*\*как восстанавливаем\*\*, \*\*как доказываем\*\* (evidence);

\- restore-drill проводится регулярно и фиксируется как факт (RAW+DIGEST);

\- любые аварийные восстановления выполняются по runbook и оставляют трассу.



Главный принцип: \*\*не верим словам — верим доказательствам\*\*.



---



\## 1) Scope (что входит)



\### 1.1 Что обязано покрываться DR

\- \*\*Postgres\*\*: дамп БД (custom format) + (опционально) globals (roles).

\- \*\*Ops evidence\*\*: логи прогонов, summary, digest.

\- \*\*Compose/Run конфиги\*\*: только как \*safe snapshots\* (без секретов / с редактированием).



\### 1.2 Что НЕ входит (и почему)

\- Выгрузка секретов наружу, публикации дампов — запрещено без процедуры T5 Secrets/PII.

\- “Слить всё в один архив и закинуть куда-то” — запрещено.

\- “Отключить безопасность ради скорости” — запрещено.



---



\## 2) RPO / RTO (реалистично)



\### 2.1 Цели по умолчанию (локальный air-gapped контур)

\- \*\*RPO (потеря данных):\*\* до последнего успешного backup (обычно ≤ 24ч).

\- \*\*RTO (время восстановления):\*\* 30–90 минут до работоспособного API, если железо живо.



\### 2.2 Приоритеты восстановления

1\) Поднять Postgres (данные + целостность).  

2\) Поднять API/worker/beat.  

3\) Прогнать smoke и зафиксировать PASS.  

4\) Только потом — “красота”, оптимизации, чистка.



---



\## 3) Где хранится (локально) и как выглядит структура



\### 3.1 Backup root

По умолчанию: `ops/\_backups/<stamp>/`



Пример:

\- `ops/\_backups/20251227-184012/`

&nbsp; - `db.dump`

&nbsp; - `globals.sql` (опционально)

&nbsp; - `manifest.json`

&nbsp; - `backup.log`

&nbsp; - `compose\_ps.txt` (опционально)



\### 3.2 Evidence root

\- `ops/\_local/evidence/<run\_id>/...`

&nbsp; - RAW: логи, выводы команд

&nbsp; - DIGEST: sha256 файлов/артефактов

&nbsp; - summary.json: итог прогонов



---



\## 4) Инструменты (A-ветка)



\### 4.1 Скрипты

\- `scripts/pwsh/ff-backup.ps1` — делает backup + manifest + digest.

\- `scripts/pwsh/ff-restore.ps1` — восстанавливает из backup по manifest.

\- `scripts/pwsh/ff-restore-drill.ps1` — weekly restore-drill в отдельном compose-project.



\### 4.2 Отдельный compose-project для drill

\- `docker-compose.drill.override.yml` — override для postgres volume/port, чтобы не трогать “боевую” БД.



---



\## 5) Процедура Backup (операторская)



\### 5.1 Правило запуска

Backup запускается:

\- перед релизом (gate),

\- перед “опасными” миграциями,

\- регулярно по расписанию (минимум 1 раз/сутки при активной разработке).



\### 5.2 Команда (ручной запуск)

Из `A-run`:



```powershell

pwsh -NoProfile -File .\\scripts\\pwsh\\ff-backup.ps1



