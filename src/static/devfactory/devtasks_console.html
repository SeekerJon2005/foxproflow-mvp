<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>FoxProFlow ‚Ä¢ DevTasks Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #050608;
      --bg-alt: #0b0f14;
      --panel: #10151f;
      --panel-alt: #151c27;
      --border: #222b3a;
      --accent: #ff7a3c;
      --accent-soft: rgba(255, 122, 60, 0.14);
      --accent-strong: rgba(255, 122, 60, 0.25);
      --text: #f5f7ff;
      --text-muted: #9ca7c0;
      --danger: #ff4d4f;
      --success: #42be65;
      --radius-lg: 14px;
      --radius-sm: 8px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #161b2b 0, #050608 55%);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
    }

    header {
      padding: 16px 24px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(to right, rgba(11, 15, 20, 0.95), rgba(10, 14, 20, 0.8));
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(12px);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-mark {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #ffd2b3, #ff7a3c 45%, #ff4b16 75%);
      box-shadow: 0 0 18px rgba(255, 122, 60, 0.55);
      position: relative;
      overflow: hidden;
    }

    .brand-mark::after {
      content: "";
      position: absolute;
      inset: 5px 6px 6px 8px;
      border-radius: 50%;
      background: radial-gradient(circle at 20% 20%, transparent 0, transparent 40%, rgba(0,0,0,0.8) 75%);
    }

    .brand-title {
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.03em;
    }

    .brand-sub {
      font-size: 11px;
      color: var(--text-muted);
      letter-spacing: 0.07em;
      text-transform: uppercase;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 11px;
      color: var(--text-muted);
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .pill {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(8, 12, 18, 0.95);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      box-shadow: 0 0 8px rgba(66, 190, 101, 0.9);
    }

    .pill-small {
      border-radius: 999px;
      padding: 2px 8px;
      border: 1px solid rgba(48, 60, 87, 0.9);
      background: rgba(11, 16, 25, 0.98);
      font-size: 10px;
      color: var(--text-muted);
    }

    main {
      padding: 16px 20px 20px;
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1.1fr);
      gap: 16px;
      align-items: flex-start;
    }

    @media (max-width: 1100px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .panel {
      background: linear-gradient(145deg, rgba(16, 21, 31, 0.98), rgba(9, 13, 20, 0.98));
      border-radius: var(--radius-lg);
      border: 1px solid rgba(28, 38, 55, 0.85);
      box-shadow:
        0 24px 40px rgba(0, 0, 0, 0.65),
        0 0 0 1px rgba(155, 168, 204, 0.04);
      padding: 14px 14px 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 0;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 4px;
    }

    .panel-title {
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .panel-title span.icon {
      font-size: 14px;
    }

    .panel-subtitle {
      font-size: 11px;
      color: var(--text-muted);
    }

    .panel-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .btn {
      border: 1px solid var(--border);
      border-radius: 999px;
      background: rgba(9, 13, 21, 0.98);
      color: var(--text);
      padding: 5px 12px;
      font-size: 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition:
        background 0.1s ease-out,
        transform 0.04s ease-out,
        box-shadow 0.1s ease-out,
        border-color 0.1s ease-out;
    }

    .btn.primary {
      border-color: var(--accent);
      background: radial-gradient(circle at 0 0, rgba(255, 204, 170, 0.07), var(--accent-soft));
      box-shadow: 0 0 0 1px rgba(255, 122, 60, 0.35);
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    .btn[disabled] {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }

    .filters .input {
      min-width: 140px;
      flex: 0 0 auto;
    }

    input[type="text"],
    select {
      border-radius: 999px;
      border: 1px solid rgba(46, 59, 83, 0.9);
      background: rgba(11, 15, 24, 0.98);
      color: var(--text);
      padding: 6px 9px;
      font-size: 11px;
      font-family: inherit;
      outline: none;
      transition: border-color 0.12s ease-out, box-shadow 0.12s ease-out, background 0.12s ease-out;
    }

    input::placeholder {
      color: var(--text-muted);
    }

    input:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(255, 122, 60, 0.4);
      background: rgba(11, 16, 26, 0.98);
    }

    .tasks-container {
      border-radius: var(--radius-sm);
      background: rgba(9, 13, 23, 0.9);
      border: 1px solid rgba(40, 52, 76, 0.9);
      overflow: hidden;
      min-height: 150px;
      max-height: 440px;
      display: flex;
      flex-direction: column;
    }

    .tasks-header-row,
    .tasks-row {
      display: grid;
      grid-template-columns: 0.55fr 0.7fr 0.45fr 0.7fr 0.5fr 0.5fr;
      gap: 8px;
      align-items: center;
      padding: 6px 10px;
      font-size: 11px;
    }

    @media (max-width: 1200px) {
      .tasks-header-row,
      .tasks-row {
        grid-template-columns: 0.55fr 0.85fr 0.6fr 0.7fr;
      }

      .col-devlinks,
      .col-updated {
        display: none;
      }
    }

    .tasks-header-row {
      background: rgba(15, 20, 32, 0.95);
      border-bottom: 1px solid rgba(46, 59, 83, 0.9);
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .tasks-body {
      overflow: auto;
    }

    .tasks-row {
      cursor: pointer;
      border-bottom: 1px solid rgba(22, 31, 47, 0.9);
    }

    .tasks-row:last-child {
      border-bottom: none;
    }

    .tasks-row:hover {
      background: linear-gradient(to right, rgba(255, 122, 60, 0.08), rgba(9, 13, 23, 0.95));
    }

    .tasks-row.selected {
      background: linear-gradient(to right, rgba(255, 122, 60, 0.19), rgba(9, 13, 25, 0.95));
      box-shadow: inset 2px 0 0 var(--accent);
    }

    .muted {
      color: var(--text-muted);
    }

    .mono {
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 2px 9px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid rgba(69, 84, 115, 0.9);
      background: rgba(15, 21, 31, 0.95);
      color: var(--text-muted);
      white-space: nowrap;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent);
    }

    .status-new {
      border-color: var(--accent);
      background: rgba(255, 122, 60, 0.1);
      color: #ffd5c1;
    }

    .status-progress {
      border-color: #facc15;
      background: rgba(250, 204, 21, 0.08);
      color: #fef9c3;
    }

    .status-done {
      border-color: var(--success);
      background: rgba(66, 190, 101, 0.09);
      color: #bbf7d0;
    }

    .status-failed {
      border-color: var(--danger);
      background: rgba(248, 113, 113, 0.09);
      color: #fecaca;
    }

    .badge {
      border-radius: 999px;
      padding: 2px 8px;
      border: 1px solid rgba(39, 52, 82, 0.9);
      background: rgba(9, 13, 23, 0.96);
      font-size: 10px;
      color: var(--text-muted);
    }

    .details-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 10px;
    }

    .details-section {
      border-radius: var(--radius-sm);
      background: rgba(9, 13, 23, 0.9);
      border: 1px solid rgba(40, 52, 76, 0.9);
      padding: 10px 10px 8px;
      font-size: 11px;
    }

    .details-section header {
      padding: 0 0 6px;
      margin: 0 0 6px;
      border: none;
      justify-content: space-between;
      background: transparent;
      display: flex;
      align-items: center;
    }

    .details-section header h3 {
      margin: 0;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
    }

    .details-row {
      display: grid;
      grid-template-columns: 120px minmax(0, 1fr);
      gap: 4px 8px;
      margin-bottom: 4px;
    }

    .details-row-label {
      color: var(--text-muted);
    }

    .details-row-value {
      word-break: break-word;
    }

    textarea.details-code {
      border-radius: 10px;
      border: 1px solid rgba(46, 59, 83, 0.9);
      background: rgba(11, 15, 24, 0.98);
      color: var(--text);
      padding: 6px 8px;
      font-size: 11px;
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      resize: vertical;
      min-height: 80px;
      outline: none;
    }

    textarea.details-code:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(255, 122, 60, 0.4);
      background: rgba(11, 16, 26, 0.98);
    }

    .hint {
      font-size: 10px;
      color: var(--text-muted);
    }

    .log {
      font-size: 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      color: var(--text-muted);
      opacity: 0.85;
    }

    .log .error {
      color: var(--danger);
    }

    .log .ok {
      color: var(--success);
    }

    footer {
      padding: 6px 18px 10px;
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      border-top: 1px solid rgba(15, 23, 42, 0.9);
      background: radial-gradient(circle at 50% 0, rgba(15, 23, 42, 0.94), rgba(2, 6, 23, 1));
    }

    footer span {
      white-space: nowrap;
    }

    footer .footer-left {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    footer .footer-right {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
  </style>
</head>
<body>
<header>
  <div class="brand">
    <div class="brand-mark"></div>
    <div>
      <div class="brand-title">DevFactory ‚Ä¢ DevTasks</div>
      <div class="brand-sub">FoxProFlow Earth Stack ¬∑ Task Stream</div>
    </div>
  </div>
  <div class="header-right">
    <div class="pill">
      <span class="pill-dot"></span>
      <span>API <span class="mono">/api/devfactory/tasks</span></span>
    </div>
    <div class="pill-small">
      Local ¬∑ <span class="mono">http://localhost:8080</span>
    </div>
  </div>
</header>

<main>
  <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å: —Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á -->
  <section class="panel">
    <div class="panel-header">
      <div>
        <div class="panel-title">
          <span class="icon">üß©</span>
          <span>–°–ø–∏—Å–æ–∫ DevTasks</span>
        </div>
        <div class="panel-subtitle">–¢–µ–∫—É—â–∏–µ –∑–∞–¥–∞—á–∏ DevFactory –ø–æ –≤—Å–µ–º —Å—Ç–µ–∫–∞–º.</div>
      </div>
      <div class="panel-actions">
        <button class="btn" id="btn-refresh">–û–±–Ω–æ–≤–∏—Ç—å</button>
        <span class="badge">–í—Å–µ–≥–æ: <span id="tasks-count" class="mono">0</span></span>
      </div>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="filters">
      <input
        type="text"
        id="filter-q"
        class="input"
        placeholder="–§–∏–ª—å—Ç—Ä –ø–æ ID / —Ü–µ–ª–∏"
      />
      <select id="filter-status" class="input">
        <option value="">–°—Ç–∞—Ç—É—Å: –ª—é–±–æ–π</option>
        <option value="new">new</option>
        <option value="in_progress">in_progress</option>
        <option value="awaiting_review">awaiting_review</option>
        <option value="completed">completed</option>
        <option value="failed">failed</option>
        <option value="cancelled">cancelled</option>
      </select>
      <select id="filter-stack" class="input">
        <option value="">–°—Ç–µ–∫: –ª—é–±–æ–π</option>
        <option value="python/backend">python/backend</option>
        <option value="psql/schema">psql/schema</option>
        <option value="html/ui">html/ui</option>
        <option value="powershell">powershell</option>
        <option value="flowmeta">flowmeta</option>
        <option value="flowworld">flowworld</option>
      </select>
      <input
        type="text"
        id="filter-devorder"
        class="input"
        placeholder="DevOrder id (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"
      />
      <input
        type="text"
        id="filter-flowmind"
        class="input"
        placeholder="FlowMind plan id (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)"
      />
    </div>

    <!-- –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á -->
    <div class="tasks-container">
      <div class="tasks-header-row">
        <div>ID</div>
        <div>–¶–µ–ª—å</div>
        <div>–°—Ç–∞—Ç—É—Å</div>
        <div class="col-devlinks">DevOrder / FlowMind</div>
        <div>–°–æ–∑–¥–∞–Ω</div>
        <div class="col-updated">–û–±–Ω–æ–≤–ª—ë–Ω</div>
      </div>
      <div class="tasks-body" id="tasks-body">
        <!-- —Å—Ç—Ä–æ–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç JS -->
      </div>
    </div>

    <div class="hint">
      –ö–ª–∏–∫ –ø–æ —Å—Ç—Ä–æ–∫–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏ —Å–ø—Ä–∞–≤–∞.  
      DevTasks Console –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç–∞ –∏–∑ DevOrders Console c –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º <span class="mono">dev_order_id</span> –∏ <span class="mono">flowmind_plan_id</span> –≤ query-–ø–∞—Ä–∞–º–µ—Ç—Ä–∞—Ö.
    </div>
  </section>

  <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å: –¥–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏ -->
  <section class="panel">
    <div class="panel-header">
      <div>
        <div class="panel-title">
          <span class="icon">üîç</span>
          <span>DevTask ¬∑ –¥–µ—Ç–∞–ª–∏</span>
        </div>
        <div class="panel-subtitle">–¶–µ–ª—å –∑–∞–¥–∞—á–∏, —Å—Ç–µ–∫, IntentSpec/ResultSpec, DevOrder/FlowMind.</div>
      </div>
      <div class="panel-actions">
        <span class="badge">–¢–µ–∫—É—â–∞—è –∑–∞–¥–∞—á–∞: <span id="current-task-id" class="mono">‚Äî</span></span>
      </div>
    </div>

    <div class="details-grid">
      <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è -->
      <div class="details-section">
        <header>
          <h3>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
        </header>
        <div id="details-main">
          <div class="hint">
            –í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á—É —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø–æ–ª—è.
          </div>
        </div>
      </div>

      <!-- Intent / Result -->
      <div class="details-section">
        <header>
          <h3>Intent / Result</h3>
        </header>
        <div>
          <div class="details-row">
            <div class="details-row-label">IntentSpec</div>
            <div class="details-row-value">
              <textarea id="details-intent" class="details-code" readonly></textarea>
            </div>
          </div>
          <div class="details-row">
            <div class="details-row-label">ResultSpec</div>
            <div class="details-row-value">
              <textarea id="details-result" class="details-code" readonly></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- –õ–æ–≥ -->
      <div class="details-section">
        <header>
          <h3>Log</h3>
        </header>
        <div class="log" id="details-log"></div>
      </div>
    </div>
  </section>
</main>

<footer>
  <div class="footer-left">
    <span>FoxProFlow DevFactory</span>
    <span class="muted">DevTasks Console ¬∑ v1.0</span>
  </div>
  <div class="footer-right">
    <span class="muted">–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö: /api/devfactory/tasks & /api/devfactory/tasks/{id}</span>
  </div>
</footer>

<script>
  const API_BASE = ""; // same origin (http://localhost:8080)

  const tasksBodyEl = document.getElementById("tasks-body");
  const tasksCountEl = document.getElementById("tasks-count");
  const btnRefresh = document.getElementById("btn-refresh");

  const filterQEl = document.getElementById("filter-q");
  const filterStatusEl = document.getElementById("filter-status");
  const filterStackEl = document.getElementById("filter-stack");
  const filterDevOrderEl = document.getElementById("filter-devorder");
  const filterFlowMindEl = document.getElementById("filter-flowmind");

  const currentTaskIdEl = document.getElementById("current-task-id");
  const detailsMainEl = document.getElementById("details-main");
  const detailsIntentEl = document.getElementById("details-intent");
  const detailsResultEl = document.getElementById("details-result");
  const detailsLogEl = document.getElementById("details-log");

  let lastTasks = [];
  let currentTaskId = null;

  function clearChildren(el) {
    while (el.firstChild) {
      el.removeChild(el.firstChild);
    }
  }

  function fmtDate(iso) {
    if (!iso) return "‚Äî";
    const d = new Date(iso);
    if (isNaN(d.getTime())) return iso;
    return d.toLocaleString();
  }

  function statusClass(status) {
    const s = (status || "").toLowerCase();
    if (s === "new") return "status-pill status-new";
    if (["in_progress", "awaiting_review"].includes(s)) return "status-pill status-progress";
    if (["completed", "done"].includes(s)) return "status-pill status-done";
    if (["failed", "error", "cancelled"].includes(s)) return "status-pill status-failed";
    return "status-pill";
  }

  function normalizeTasksResponse(data) {
    if (Array.isArray(data)) return data;
    if (Array.isArray(data.tasks)) return data.tasks;
    if (Array.isArray(data.items)) return data.items;
    if (Array.isArray(data.results)) return data.results;
    return [];
  }

  function normalizeTaskFields(task) {
    const meta = task.meta || task.meta_json || {};

    const id = task.id ?? task.task_id ?? task.dev_task_id ?? null;
    const status =
      task.status ?? task.task_status ?? task.dev_task_status ?? "unknown";
    const stack = task.stack ?? task.tech_stack ?? task.layer ?? "‚Äî";
    const goal = task.goal ?? task.title ?? task.summary ?? "(–±–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è)";

    const devOrderId =
      task.dev_order_id ??
      task.order_id ??
      task.devorder_id ??
      meta.dev_order_id ??
      meta.dev_order_public_id ??
      meta.devorder_id ??
      "‚Äî";

    const flowmindPlanId =
      task.flowmind_plan_id ??
      meta.flowmind_plan_id ??
      meta.flowmind_plan ??
      "‚Äî";

    const createdAt =
      task.created_at ?? task.created ?? task.ts_created ?? null;
    const updatedAt =
      task.updated_at ?? task.updated ?? task.ts_updated ?? null;

    return {
      id,
      status,
      stack,
      goal,
      devOrderId,
      flowmindPlanId,
      createdAt,
      updatedAt,
      raw: task,
      meta
    };
  }

  function applyLocalFilter(tasks) {
    const text = (filterQEl?.value || "").trim().toLowerCase();
    const devOrder = (filterDevOrderEl?.value || "").trim().toLowerCase();
    const flowMind = (filterFlowMindEl?.value || "").trim().toLowerCase();

    let list = tasks.slice();

    if (text) {
      list = list.filter((t) => {
        const inId = String(t.id ?? "").toLowerCase().includes(text);
        const inGoal = (t.goal || "").toLowerCase().includes(text);
        return inId || inGoal;
      });
    }

    if (devOrder) {
      list = list.filter((t) =>
        String(t.devOrderId ?? "").toLowerCase().includes(devOrder)
      );
    }

    if (flowMind) {
      list = list.filter((t) =>
        String(t.flowmindPlanId ?? "").toLowerCase().includes(flowMind)
      );
    }

    return list;
  }

  function renderTasks(tasks) {
    clearChildren(tasksBodyEl);

    if (!tasks.length) {
      const row = document.createElement("div");
      row.className = "tasks-row";
      row.innerHTML = `<div class="muted">–ó–∞–¥–∞—á–∏ DevFactory –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ —Ç–µ–∫—É—â–µ–º—É —Ñ–∏–ª—å—Ç—Ä—É.</div>`;
      tasksBodyEl.appendChild(row);
      return;
    }

    for (const t of tasks) {
      const row = document.createElement("div");
      row.className = "tasks-row";
      row.dataset.taskId = t.id;

      const statusCls = statusClass(t.status);

      row.innerHTML = `
        <div class="mono">${t.id ?? "‚Äî"}</div>
        <div>${t.goal}</div>
        <div><span class="${statusCls}"><span class="status-dot"></span>${t.status}</span></div>
        <div class="col-devlinks">
          <div class="mono">${t.devOrderId}</div>
          <div class="mono muted">${t.flowmindPlanId}</div>
        </div>
        <div class="mono">${fmtDate(t.createdAt)}</div>
        <div class="col-updated mono">${fmtDate(t.updatedAt)}</div>
      `;

      row.addEventListener("click", () => {
        selectTaskRow(t.id);
        loadTaskDetails(t.id);
      });

      tasksBodyEl.appendChild(row);
    }

    if (!currentTaskId && tasks.length > 0) {
      const firstId = tasks[0].id;
      selectTaskRow(firstId);
      loadTaskDetails(firstId);
    }
  }

  function selectTaskRow(taskId) {
    currentTaskId = taskId;
    currentTaskIdEl.textContent = taskId ?? "‚Äî";
    const rows = tasksBodyEl.querySelectorAll(".tasks-row");
    rows.forEach((row) => {
      if (row.dataset.taskId === String(taskId)) {
        row.classList.add("selected");
      } else {
        row.classList.remove("selected");
      }
    });
    detailsLogEl.innerHTML = "";
  }

  async function loadTasks() {
    if (!btnRefresh) return;
    btnRefresh.disabled = true;

    try {
      const qs = [];
      const status = filterStatusEl?.value || "";
      const stack = filterStackEl?.value || "";
      const devOrder = filterDevOrderEl?.value || "";

      if (status) qs.push("status=" + encodeURIComponent(status));
      if (stack) qs.push("stack=" + encodeURIComponent(stack));
      if (devOrder) qs.push("dev_order_id=" + encodeURIComponent(devOrder));

      qs.push("limit=100");

      const url = `${API_BASE}/api/devfactory/tasks` + (qs.length ? "?" + qs.join("&") : "");
      const res = await fetch(url, { method: "GET" });

      if (!res.ok) {
        throw new Error(`HTTP ${res.status}`);
      }

      const data = await res.json();
      const rawList = normalizeTasksResponse(data);
      const normalized = rawList.map(normalizeTaskFields);
      lastTasks = normalized;
      tasksCountEl.textContent = String(normalized.length);

      const locallyFiltered = applyLocalFilter(normalized);
      renderTasks(locallyFiltered);
    } catch (err) {
      console.error("loadTasks error:", err);
      tasksCountEl.textContent = "0";
      lastTasks = [];
      clearChildren(tasksBodyEl);
      const row = document.createElement("div");
      row.className = "tasks-row";
      row.innerHTML = `<div class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á: ${err.message}</div>`;
      tasksBodyEl.appendChild(row);
    } finally {
      btnRefresh.disabled = false;
    }
  }

  async function loadTaskDetails(taskId) {
    if (!taskId) return;
    try {
      const url = `${API_BASE}/api/devfactory/tasks/${encodeURIComponent(taskId)}`;
      const res = await fetch(url, { method: "GET" });

      if (!res.ok) {
        throw new Error(`HTTP ${res.status}`);
      }

      const data = await res.json();
      renderTaskDetails(data);
    } catch (err) {
      console.error("loadTaskDetails error:", err);
      detailsMainEl.innerHTML = `<div class="hint">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á–∏: ${err.message}</div>`;
      detailsIntentEl.value = "";
      detailsResultEl.value = "";
      detailsLogEl.innerHTML = `<span class="error">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ /api/devfactory/tasks/${taskId}: ${err.message}</span>`;
    }
  }

  function renderTaskDetails(task) {
    const t = normalizeTaskFields(task);

    const html = `
      <div class="details-row">
        <div class="details-row-label">ID –∑–∞–¥–∞—á–∏</div>
        <div class="details-row-value mono">${t.id ?? "‚Äî"}</div>
      </div>
      <div class="details-row">
        <div class="details-row-label">–°—Ç–∞—Ç—É—Å</div>
        <div class="details-row-value">
          <span class="${statusClass(t.status)}">
            <span class="status-dot"></span>${t.status}
          </span>
        </div>
      </div>
      <div class="details-row">
        <div class="details-row-label">–°—Ç–µ–∫</div>
        <div class="details-row-value mono">${t.stack}</div>
      </div>
      <div class="details-row">
        <div class="details-row-label">DevOrder</div>
        <div class="details-row-value mono">${t.devOrderId}</div>
      </div>
      <div class="details-row">
        <div class="details-row-label">FlowMind –ø–ª–∞–Ω</div>
        <div class="details-row-value mono">${t.flowmindPlanId}</div>
      </div>
      <div class="details-row">
        <div class="details-row-label">–¶–µ–ª—å</div>
        <div class="details-row-value">${t.goal}</div>
      </div>
      <div class="details-row">
        <div class="details-row-label">–°–æ–∑–¥–∞–Ω</div>
        <div class="details-row-value mono">${fmtDate(t.createdAt)}</div>
      </div>
      <div class="details-row">
        <div class="details-row-label">–û–±–Ω–æ–≤–ª—ë–Ω</div>
        <div class="details-row-value mono">${fmtDate(t.updatedAt)}</div>
      </div>
    `;

    detailsMainEl.innerHTML = html;

    const intent =
      task.intent_spec ??
      task.intent ??
      task.intent_json ??
      task.intent_text ??
      "";
    const result =
      task.result_spec ??
      task.result ??
      task.result_json ??
      task.result_text ??
      "";

    detailsIntentEl.value = intent
      ? typeof intent === "string"
        ? intent
        : JSON.stringify(intent, null, 2)
      : "";
    detailsResultEl.value = result
      ? typeof result === "string"
        ? result
        : JSON.stringify(result, null, 2)
      : "";

    detailsLogEl.innerHTML =
      '<span class="ok">–î–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏ –ø–æ–ª—É—á–µ–Ω—ã –∏–∑ /api/devfactory/tasks/' +
      t.id +
      "</span>";
  }

  function applyUrlPrefill() {
    try {
      const params = new URLSearchParams(window.location.search);
      const devOrder = params.get("dev_order_id");
      const flowPlan = params.get("flowmind_plan_id");

      if (devOrder && filterDevOrderEl) {
        filterDevOrderEl.value = devOrder;
      }
      if (flowPlan && filterFlowMindEl) {
        filterFlowMindEl.value = flowPlan;
      }
    } catch (e) {
      console.warn("URL params parse failed:", e);
    }
  }

  function initEvents() {
    applyUrlPrefill();

    if (btnRefresh) {
      btnRefresh.addEventListener("click", () => {
        loadTasks();
      });
    }

    if (filterQEl) {
      filterQEl.addEventListener("input", () => {
        const locallyFiltered = applyLocalFilter(lastTasks);
        renderTasks(locallyFiltered);
      });
    }

    if (filterStatusEl) {
      filterStatusEl.addEventListener("change", () => {
        loadTasks();
      });
    }

    if (filterStackEl) {
      filterStackEl.addEventListener("change", () => {
        loadTasks();
      });
    }

    if (filterDevOrderEl) {
      filterDevOrderEl.addEventListener("input", () => {
        const locallyFiltered = applyLocalFilter(lastTasks);
        renderTasks(locallyFiltered);
      });
    }

    if (filterFlowMindEl) {
      filterFlowMindEl.addEventListener("input", () => {
        const locallyFiltered = applyLocalFilter(lastTasks);
        renderTasks(locallyFiltered);
      });
    }

    window.addEventListener("load", () => {
      loadTasks();
    });
  }

  initEvents();
</script>
</body>
</html>
